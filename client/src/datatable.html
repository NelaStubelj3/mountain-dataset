<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mountain Data Table</title>

    <link rel="stylesheet" type="text/css" href="./App.css" />
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <div class="App">
      <div>
        <form onSubmit="filterForm">
          <label htmlFor="filterText">Enter search text:</label>
          <input type="text" id="filterText" name="filterText" />

          <label for="filterAttribute">Choose a search attribute:</label>
          <select id="filterAttribute">
            <option value="all">All fields(Wildcard)</option>
            <option value="mountain_name">Mountain name</option>
            <option value="country">Country</option>
          </select>

          <button type="button" onclick="filterData()">Search</button>
        </form>

        <table id="mountainTable">
          <thead>
            <tr>
              <th>Mountain id</th>
              <th>Mountain name</th>
              <th>Country</th>
              <th>Height (m)</th>
              <th>Mountain description</th>
              <th>Highest peak</th>
              <th>Trail id</th>
              <th>Trail name</th>
              <th>Trail description</th>
              <th>Difficulty</th>
              <th>Length (km)</th>
              <th>Elevation gain (m)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <button type="button" onclick="downloadData('csv')">
          Download CSV
        </button>
        <button type="button" onclick="downloadData('json')">
          Download JSON
        </button>
        <a href="./index.html" class="link-button">Go to homepage</a>
      </div>
    </div>

    <script>
      {
        let filterText = document.getElementById("filterText");
        let filterAttribute = document.getElementById("filterAttribute");
        let mountainTableBody = document.querySelector("#mountainTable tbody");

        let listOfMountains = [];
        let filteredMountains = [];

        fetchData();

        function fetchData() {
          fetch("http://localhost:3001/mountainsall")
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              if (data.status == "OK") {
                listOfMountains = data.response;
                displayData(listOfMountains);
              }
            })
            .catch((error) => {
              console.error("Error fetching data:", error);
            });
        }

        function filterData() {
          let filterTextValue = filterText.value.toLowerCase();
          let filterAttributeValue = filterAttribute.value.toLowerCase();

          if (!filterTextValue && filterAttributeValue === "all") {
            displayData(listOfMountains);
            return;
          }

          filteredMountains = listOfMountains.filter((mountain) => {
            if (filterAttributeValue === "mountain_name") {
              return mountain.mountain_name
                .toLowerCase()
                .includes(filterTextValue);
            } else if (filterAttributeValue === "country") {
              return mountain.country.toLowerCase().includes(filterTextValue);
            } else {
              for (const key in mountain) {
                if (Object.prototype.hasOwnProperty.call(mountain, key)) {
                  const attributeValue = mountain[key].toString().toLowerCase();
                  if (attributeValue.includes(filterTextValue)) {
                    return true;
                  }
                }
              }
            }

            return false;
          });

          displayData(filteredMountains);
        }

        function displayData(mountains) {
          mountainTableBody.innerHTML = "";

          mountains.forEach(function (mountain) {
            const row = document.createElement("tr");
            row.innerHTML = `
          <td>${mountain.mountain_id}</td>
          <td>${mountain.mountain_name}</td>
          <td>${mountain.country}</td>
          <td>${mountain.height}</td>
          <td>${mountain.mountain_description}</td>
          <td>${mountain.highest_peak}</td>
          <td>${mountain.trail_id}</td>
          <td>${mountain.trail_name}</td>
          <td>${mountain.trail_description}</td>
          <td>${mountain.difficulty}</td>
          <td>${mountain.length}</td>
          <td>${mountain.elevation_gain}</td>

        `;
            mountainTableBody.appendChild(row);
          });
        }

        function downloadData(format) {
          const dataToDownload = filterText.value
            ? filteredMountains
            : listOfMountains;

          if (format === "csv") {
            const csvContent =
              "data:text/csv;charset=utf-8," +
              dataToDownload
                .map((row) => Object.values(row).join(","))
                .join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "podaci.csv");
            document.body.appendChild(link);
            link.click();
          } else if (format === "json") {
            const jsonContent = JSON.stringify(dataToDownload, null, 2);

            const blob = new Blob([jsonContent], { type: "application/json" });
            const link = document.createElement("a");
            link.setAttribute("href", URL.createObjectURL(blob));
            link.setAttribute("download", "podaci.json");
            document.body.appendChild(link);
            link.click();
          }
        }
      }
    </script>
  </body>
</html>
